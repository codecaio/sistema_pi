<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Codex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Codex</a>
        <button class="btn btn-outline-light" id="logoutBtn">Sair</button>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <aside class="col-md-2 bg-light border-end" style="min-height: 100vh;">
            <div class="p-3">
                <button class="btn btn-sm btn-success w-100 mb-2" id="addCam">Adicionar câmera</button>
                <button class="btn btn-sm btn-danger w-100 mb-3" id="removeCam">Remover câmera</button>
                <ul class="list-group" id="cameraList"></ul>
            </div>
        </aside>
        <main class="col-md-10 p-3 text-center">
            <img id="video" class="img-fluid" alt="Stream" />
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

const token = localStorage.getItem('token');

if (!token) {
    window.location.href = "/login"; // força login se não tiver token
} else {
    // Atualiza o src da imagem com o token na URL
    document.getElementById("video").src = `/video_feed?token=${token}`;
}
const video = document.getElementById('video');
video.src = `/video_feed?token=${token}`;

async function loadCameras() {
    const res = await fetch('/cameras', { headers: { Authorization: `Bearer ${token}` } });
    const data = await res.json();
    const list = document.getElementById('cameraList');
    list.innerHTML = '';
    data.cameras.forEach(id => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = `Câmera ${id}`;
        li.onclick = () => selectCamera(id);
        list.appendChild(li);
    });
}

async function selectCamera(id) {
    await fetch('/select_camera', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ camera: id })
    });
}

document.getElementById('addCam').onclick = () => {
    const list = document.getElementById('cameraList');
    const newId = list.children.length + 1;
    const li = document.createElement('li');
    li.className = 'list-group-item list-group-item-action';
    li.textContent = `Câmera ${newId}`;
    li.onclick = () => selectCamera(newId);
    list.appendChild(li);
};

document.getElementById('removeCam').onclick = () => {
    const list = document.getElementById('cameraList');
    if (list.lastChild) list.removeChild(list.lastChild);
};

document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('token');
    window.location.href = 'login.html';
};

loadCameras();
</script>
</body>
</html>